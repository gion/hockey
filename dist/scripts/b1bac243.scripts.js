"use strict";var angularGameApp=angular.module("angularGameApp",["ui"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:token/:name",{templateUrl:"views/game.html",controller:"GameCtrl"}).otherwise({redirectTo:"/"})}]);"use strict",angularGameApp.factory("config",["$rootScope","$window",function(a,b){var c={socketUrl:"http://192.168.1.148",socketPort:"8181"};return c.socketAddress=c.socketUrl+":"+c.socketPort,c}]),"use strict",angularGameApp.factory("socket",["$rootScope","$window","config",function(a,b,c){var d=b.io.connect(c.socketAddress);return{on:function(b,c){d.on(b,function(){var b=arguments;a.$apply(function(){c.apply(d,b)})})},emit:function(b,c,e){d.emit(b,c,function(){var b=arguments;a.$apply(function(){e&&e.apply(d,b)})})}}}]),"use strict",angularGameApp.controller("MainCtrl",["$scope","$rootScope","socket",function(a,b,c){a.name="no-name",a.$watch(function(){return a.token+"|"+a.name},function(b,d){a.link=a.name?window.location.toString()+a.token+"/"+window.encodeURIComponent(a.name):"",c.emit("change:name",a.name)}),window.s=c,c.on("connect",function(){b.connected=!0,c.emit("change:name",a.name),c.on("set:id",function(b){c.id=b,a.token=b,c.emit("add:user",{token:a.token,name:a.name}),c.on("initPlayer",function(){console.log("init player from main")})})})}]),"use strict",angularGameApp.controller("GameCtrl",["$scope","$rootScope","$routeParams","$q","$timeout","socket",function(a,b,c,d,e,f){var g=15,h={first:{x:null,y:null},current:{x:null,y:null},getCoord:function(a){var a=a.originalEvent?a.originalEvent:a;return{x:a.touches[0].clientX,y:a.touches[0].clientY}},start:function(b){h.first=h.getCoord(b),h.initialGoalKeeperPos=a.goalKeeperY,j(b)},move:function(a){h.first.x&&h.first.y?(h.current=h.getCoord(a),h.updateGoalKeeper(),j(a)):h.start(a)},stop:function(a){h.first={x:null,y:null},h.current={x:null,y:null},h.initialGoalKeeperPos=null,j(a)},updateGoalKeeper:function(){if(h.initialGoalKeeperPos==null||h.first.x==null||h.first.y==null||h.current.x==null||h.current.y==null)return;i(h.initialGoalKeeperPos+h.current.y-h.first.y)}},i=function(b){a.goalKeeperY=Math.min(a.mapHeight-a.goalKeeperHeight+5,Math.max(-5,b))},j=function(a){a.preventDefault(),a.stopPropagation()};a.name=c.name||"unnamed",a.waiting=!0,a.playerSide="left",a.gameOver=!1,a.mapHeight=400,a.mapWidth=600,a.goalKeeperY=125,a.goalKeeperHeight=150,a.onTouchStart=h.start,a.onTouchMove=h.move,a.onTouchend=h.stop,a.ballX=a.mapWidth/2,a.ballY=a.mapHeight/2,a.ballPosition="left:"+a.ballX+"px; top:"+a.ballY+"px",a.$watch(function(){return a.ballX+"|"+a.ballY},function(b){a.ballPosition="left:"+a.ballX+"px; top:"+a.ballY+"px";try{a.$$phase||$.scope.$apply()}catch(c){console.error(c)}}),a.$watch("player",function(b,c){try{b.side&&(a.playerSide=b.side),b.name&&(a.name=b.name)}catch(d){window.E=d,console.warn(d)}}),a.moveGoalKeeperUp=function(b){i(a.goalKeeperY-g)},a.moveGoalKeeperDown=function(b){i(a.goalKeeperY+g)},a.onMouseWheel=function(b){b=b.originalEvent?b.originalEvent:b;var c=b.detail?b.detail*-120:b.wheelDelta;a["moveGoalKeeper"+(c<0?"Down":"Up")]()};var k=function(){return f.on("connect",function(){f.emit("add:user",{token:c.token,name:prompt("And you are...")||"no-name"}),f.emit("ready")}),f.on("initPlayer",function(b){console.log("init player",b),a.playerSide=b.side,a.name=b.name}),f.on("change:side",function(b){l.pause(),l.notified=!1,console.log("changeSide",b),console.log("before"+l.pace.x+" after : "+b.pace.x),l.pace=b.pace,a.ballY=b.position.top,a.ballX=a.playerSide=="left"?a.mapWidth-b.position.left:b.position.left-a.mapWidth,l.resume()}),f.on("gameOver",function(b){var c=a.playerSide==b.winner;a.won=c?"won :)":"lost :(",a.gameOver=!0,a.score=b.score,console.error(a.won,b)}),f.on("startGame",function(b){a.ballX=a.mapWidth/2,a.ballY=a.mapHeight/2,a.playerSide=="right"&&(a.ballX-=a.mapWidth),l.pace.x=(a.playerSide=="left"?1:-1)*b.x,l.pace.y=b.y,a.gameOver=!1,a.waiting=!1,console.log("startGame",b,l.pace),l.init(),a.playerSide=="left"&&l.analyze()}),b.connected&&f.emit("ready"),{notifyServer:function(){f.emit("change:side",{pace:{x:l.pace.x,y:l.pace.y},position:l.getCoords()})},emit:f.emit,on:f.on,trigger:f.emit}}(),l={frameDuration:30,pace:{value:10,randomAngle:Math.random()*360*.0174532925,x:0,y:0},getCoords:function(){return{left:a.ballX,top:a.ballY}},setCoords:function(b){a.ballX=b.left,a.ballY=b.top},init:function(b){l.el=$("#ball"),l.$el=$(".ball",l.el),l.bounderies={left:l.$el.width()/2,top:l.$el.height()/2,right:a.mapWidth-l.$el.width()/2,bottom:a.mapHeight-l.$el.height()/2};if(b){var c=[Math.cos(l.pace.randomAngle),Math.sin(l.pace.randomAngle)],d=$.map(c,function(){return Math.abs(arguments[0])});l.pace.x=c[$.inArray(Math.max.apply(Math,d),d)]*l.pace.value,l.pace.y=c[$.inArray(Math.min.apply(Math,d),d)]*l.pace.value}},move:function(){if(window.X)return;l.pause(),a.ballY+=l.pace.y,a.ballX+=l.pace.x,l.analyze()},analyze:function(){var b=l.getCoords(),c=!1;b.left<=l.bounderies.left?a.playerSide=="left"?b.top>a.goalKeeperY&&b.top<a.goalKeeperY+a.goalKeeperHeight?l.pace.x*=-1:c=!0:l.pace.x<0&&(l.notified?b.left+l.$el.width()<0&&l.pause(!0):(l.notified=!0,console.log("NOTIFY"),k.notifyServer())):b.left>=l.bounderies.right&&(a.playerSide=="right"?b.top>a.goalKeeperY&&b.top<a.goalKeeperY+a.goalKeeperHeight?l.pace.x*=-1:c=!0:l.pace.x>0&&(l.notified?b.left-l.$el.width()>a.mapWidth&&l.pause(!0):(l.notified=!0,console.log("NOTIFY 2"),k.notifyServer())));if(b.top>=l.bounderies.bottom||b.top<=l.bounderies.top)l.pace.y*=-1;c?(k.emit("lost"),l.pause()):l.timeout=e(function(){l.move()},l.frameDuration)},pause:function(a){e.cancel(l.timeout),a&&setTimeout(function(){e.cancel(l.timeout)})},resume:function(){l.analyze()}};a.ball=l,a.io=k,a.$timeout=e,a.socket=f,a.restartGame=function(){k.emit("restart")}}]);