"use strict";var angularGameApp=angular.module("angularGameApp",["ui"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:token",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/:token/:name",{templateUrl:"views/game.html",controller:"GameCtrl"}).otherwise({redirectTo:"/"})}]);"use strict",angularGameApp.factory("config",["$rootScope","$window",function(a,b){var c={socketUrl:"http://192.168.1.148",socketPort:"8181",ballWidth:80};return c.socketAddress=c.socketUrl+":"+c.socketPort,c}]),"use strict",angularGameApp.factory("socket",["$rootScope","$window","config",function(a,b,c){var d=b.io.connect(c.socketAddress);return d.on("log",function(){console.error("remote log",arguments)}),{on:function(b,c){d.on(b,function(){var b=arguments;a.$apply(function(){c.apply(d,b)})})},emit:function(b,c,e){d.emit(b,c,function(){var b=arguments;a.$apply(function(){e&&e.apply(d,b)})})}}}]),"use strict",angularGameApp.factory("animationFrame",["$rootScope","$window","config","$timeout","socket",function(a,b,c,d,e){var f=0,g=["ms","moz","webkit","o"];for(var h=0;h<g.length&&!b.reqAnimationFrame;++h)b.reqAnimationFrame=b[g[h]+"RequestAnimationFrame"]||b.requestAnimationFrame,b.canAnimationFrame=b[g[h]+"CancelAnimationFrame"]||b[g[h]+"CancelRequestAnimationFrame"]||b.cancelRequestAnimationFrame||b.cancelAnimationFrame;return b.reqAnimationFrame||(b.reqAnimationFrame=function(a,b){var c=(new Date).getTime(),d=10,e=setTimeout(function(){a(c+d)},d);return f=c+d,e}),b.canAnimationFrame||(b.canAnimationFrame=function(a){clearTimeout(a)}),{start:b.$.proxy(b.reqAnimationFrame,window),stop:b.$.proxy(b.canAnimationFrame,window)}}]),"use strict",angularGameApp.controller("MainCtrl",["$scope","$rootScope","socket","$location",function(a,b,c,d){a.name="no-name",a.games=[],a.$watch(function(){return a.token+"|"+a.name},function(b,d){a.relativeLink=a.name?a.token+"/"+window.encodeURIComponent(a.name):"",a.link=a.name?window.location.toString()+a.token:"",c.emit("change:name",a.name)}),a.goToLink=function(){d.path(a.relativeLink)},c.on("connect",function(){b.connected=!0,c.emit("change:name",a.name),c.connected=!0,c.on("set:id",function(b){c.id=b,a.token=b,c.on("initPlayer",function(){console.log("init player from main")})}),c.on("change:games",function(b){a.games=b})})}]),"use strict",angularGameApp.controller("GameCtrl",["$scope","$rootScope","$routeParams","$q","$timeout","socket","animationFrame","$location","config",function(a,b,c,d,e,f,g,h,i){var j=angular.element,k=30,l={first:{x:null,y:null},current:{x:null,y:null},getCoord:function(a){var a=a.originalEvent?a.originalEvent:a;return{x:a.touches[0].clientX,y:a.touches[0].clientY}},start:function(b){l.first=l.getCoord(b),l.initialGoalKeeperPos=a.goalKeeperY,n(b)},move:function(a){l.first.x&&l.first.y?(l.current=l.getCoord(a),l.updateGoalKeeper(),n(a)):l.start(a)},stop:function(a){l.first={x:null,y:null},l.current={x:null,y:null},l.initialGoalKeeperPos=null,n(a)},updateGoalKeeper:function(){if(l.initialGoalKeeperPos==null||l.first.x==null||l.first.y==null||l.current.x==null||l.current.y==null)return;m(l.initialGoalKeeperPos+l.current.y-l.first.y)}},m=function(b){a.goalKeeperY=Math.min(a.mapHeight-a.goalKeeperHeight+5,Math.max(-5,b))},n=function(a){a.preventDefault(),a.stopPropagation()},o=function(){var a="shout1";if(window.HTMLAudioElement){var b=new Audio("");b.canPlayType("audio/ogg")?b=new Audio("sounds/"+a+".ogg"):b.canPlayType("audio/mp3")&&(b=new Audio("sounds/"+a+".mp3")),b.play()}else alert("HTML5 Audio is not supported by your browser!")};a.playSound=function(){o()};var p=c.name;p?p=window.decodeURIComponent(p):(p=prompt("And you are..."),h.path(c.token+"/"+p)),a.name=p,a.waiting=!0,a.playerSide="left",a.gameOver=!1,a.mapHeight=400,a.mapWidth=600,a.goalKeeperY=150,a.goalKeeperHeight=200,a.onTouchStart=l.start,a.onTouchMove=l.move,a.onTouchend=l.stop,a.ballX=a.mapWidth/2,a.ballY=a.mapHeight/2,a.ballPosition="left:"+a.ballX+"px; top:"+a.ballY+"px; width:"+i.ballWidth,a.$watch(function(){return a.ballX+"|"+a.ballY},function(b){a.ballPosition="left:"+a.ballX+"px; top:"+a.ballY+"px";try{a.$$phase||j.scope.$apply()}catch(c){console.error(c)}}),a.$watch("player",function(b,c){try{b.side&&(a.playerSide=b.side),b.name&&(a.name=b.name)}catch(d){window.E=d,console.warn(d)}}),a.score=[],a.scoreboard="",a.$watch(function(){return a.score&&a.score.length>=2?a.score[0].score+"|"+a.score[1].score:""},function(){var b=a.score;b&&b.length&&b.length>=2&&(a.scoreboard=b[0].name+" "+b[0].score+"  -  "+b[1].score+" "+b[1].name)}),a.moveGoalKeeperUp=function(b){m(a.goalKeeperY-k)},a.moveGoalKeeperDown=function(b){m(a.goalKeeperY+k)},a.onMouseWheel=function(b){b=b.originalEvent?b.originalEvent:b;var c=b.detail?b.detail*-120:b.wheelDelta;a["moveGoalKeeper"+(c<0?"Down":"Up")]()},a.restartGame=function(a){q.emit("restart")};var q=function(){return f.connected?f.emit("add:user",{token:c.token,name:a.name}):f.on("connect",function(){f.emit("add:user",{token:c.token,name:a.name}),f.emit("ready")}),f.on("initPlayer",function(b){console.log("init player",b),a.playerSide=b.side,a.name=b.name}),f.on("change:side",function(b){r.pause(),r.notified=!1,console.log("changeSide",b),r.pace=b.pace,a.ballY=b.position.top,a.ballX=a.playerSide=="left"?a.mapWidth-b.position.left+i.ballWidth:b.position.left-a.mapWidth,r.resume()}),f.on("gameOver",function(b){console.log("gameOver",b);var c=a.playerSide==b.winner;a.won=c?"won :)":"lost :(",a.gameOver=!0,a.score=b.score,console.error(a.won,b)}),f.on("startGame",function(b){a.ballX=a.mapWidth/2,a.ballY=a.mapHeight/2,a.playerSide=="right"&&(a.ballX-=a.mapWidth),r.pace.x=(a.playerSide=="left"?1:-1)*b.x,r.pace.y=b.y,a.gameOver=!1,a.waiting=!1,r.notified=!1,console.log("startGame",b,r.pace),r.init(),a.playerSide=="left"&&r.analyze()}),f.on("error:disconnect",function(a){var b=confirm("sry, but your opponent has been disconnected. Do You want to wait for other players to join?");b||(window.location="")}),b.connected&&f.emit("ready"),{notifyServer:function(){f.emit("change:side",{pace:{x:r.pace.x,y:r.pace.y},position:r.getCoords()})},emit:f.emit,on:f.on,trigger:f.emit}}(),r={frameDuration:30,pace:{value:10,randomAngle:Math.random()*360*.0174532925,x:0,y:0},getCoords:function(){return{left:a.ballX,top:a.ballY}},setCoords:function(b){a.ballX=b.left,a.ballY=b.top},levelUp:function(){var b=10,c=1.1;r.pace.x*=c,r.pace.y*=c;if(a.goalKeeperHeight<b*3)return;a.goalKeeperY+=b/2,a.goalKeeperHeight-=b},init:function(b){r.el=j("#ball"),r.$el=j(".ball",r.el),a.goalKeeperY=150,a.goalKeeperHeight=200,r.bounderies={left:r.$el.width()/2,top:r.$el.height()/2,right:a.mapWidth-r.$el.width()/2,bottom:a.mapHeight-r.$el.height()/2};if(b){var c=[Math.cos(r.pace.randomAngle),Math.sin(r.pace.randomAngle)],d=j.map(c,function(){return Math.abs(arguments[0])});r.pace.x=c[j.inArray(Math.max.apply(Math,d),d)]*r.pace.value,r.pace.y=c[j.inArray(Math.min.apply(Math,d),d)]*r.pace.value}},move:function(){r.pause();var b=40,c=1e3/b,d=(new Date).getTime(),e=r.lastMoveTimestamp?d-r.lastMoveTimestamp:c,f=e/c;r.lastMoveTimestamp=d,a.ballY+=r.pace.y*f,a.ballX+=r.pace.x*f,a.$apply(),r.analyze()},analyze:function(){var b=r.getCoords(),c=!1;b.left<=r.bounderies.left?a.playerSide=="left"?b.top>a.goalKeeperY&&b.top<a.goalKeeperY+a.goalKeeperHeight?(r.pace.x*=-1,r.levelUp(),o(),console.info("I'm left and I rejected the ball!")):(c=!0,console.info("I'm left and I suck!")):r.pace.x<0&&(console.log("OUT (I'm right)"),r.notified?b.left+r.$el.width()<0&&r.pause(!0):(r.notified=!0,console.log("NOTIFY"),q.notifyServer())):b.left>=r.bounderies.right&&(a.playerSide=="right"?b.top>a.goalKeeperY&&b.top<a.goalKeeperY+a.goalKeeperHeight?(r.pace.x*=-1,r.levelUp(),o(),console.info("I'm right and I rejected the ball!")):(c=!0,console.info("I'm right and I suck!")):r.pace.x>0&&(console.log("OUT (I'm left)"),r.notified?b.left-r.$el.width()>a.mapWidth&&r.pause(!0):(r.notified=!0,console.log("NOTIFY 2"),q.notifyServer())));if(b.top>=r.bounderies.bottom||b.top<=r.bounderies.top)r.pace.y*=-1;c?(q.emit("lost"),r.pause(!0)):r.timeout=g.start(function(){r.move()})},pause:function(a){g.stop(r.timeout),a&&(r.lastMoveTimestamp=0,setTimeout(function(){g.stop(r.timeout)},0))},resume:function(){r.analyze()}};a.ball=r,a.io=q,a.$timeout=e,a.socket=f}]);